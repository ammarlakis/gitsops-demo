name: Read Secrets and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: The environment to read secrets from
        type: choice
        options:
          - development
          - production

jobs:
  read-secrets-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: "us-east-1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read secrets from dotenv file
        uses: ammarlakis/gitsops/action/read@master
        with:
          secret_file_path: myproject/${{ github.event.inputs.environment }}-secrets.env
          include_pattern: ".*"  # Reads all secrets
          additional_args: '--kms=arn:aws:kms:us-east-1:905418242537:key/2fc869fe-3bcd-4b84-8f5d-f1ff33a4b470'

      - name: Run Deploy Script
        run: |
          myproject/deploy.sh
